
{% extends 'base.html' %}

{% block title %}Dashboard - StudyBuddy AI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white p-8 rounded-2xl shadow-md">
        <h2 class="text-3xl font-bold text-[#0E0E12] mb-6">Welcome to your Dashboard, {{ user.email }}!</h2>

        {% if message %}
            <p class="text-[#2DC6A1] mb-4">{{ message }}</p>
        {% endif %}
        {% if error %}
            <p class="text-[#FF6F61] mb-4">{{ error }}</p>
        {% endif %}

        <div class="mb-8">
            <div class="flex border-b border-gray-200">
                <button id="summary-btn" class="tab-btn active-tab" onclick="showTab('summary')">Summary</button>
                <button id="flashcards-btn" class="tab-btn" onclick="showTab('flashcards')">Flashcards</button>
                <button id="quiz-btn" class="tab-btn" onclick="showTab('quiz')">Quiz</button>
            </div>
        </div>

        <div id="summary-content" class="tab-content">
            <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Upload a File to Generate a Summary</h3>
            <form action="/upload-summary" method="post" enctype="multipart/form-data" class="mb-8 space-y-4">
                <input type="file" name="file" accept=".pdf,.docx" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-[#eaf8f4] file:text-[#2DC6A1]
                    hover:file:bg-[#d8f0e9]">
                <button type="submit" class="bg-[#2DC6A1] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#24a284] btn-primary">Upload and Generate Summary</button>
            </form>
        </div>

        <div id="flashcards-content" class="tab-content" style="display:none;">
            <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Upload a File to Generate Flashcards</h3>
            <form action="/upload-flashcards" method="post" enctype="multipart/form-data" class="mb-8 space-y-4">
                <input type="file" name="file" accept=".pdf,.docx" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-[#eaf8f4] file:text-[#2DC6A1]
                    hover:file:bg-[#d8f0e9]">
                <button type="submit" class="bg-[#2DC6A1] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#24a284] btn-primary">Upload and Generate Flashcards</button>
            </form>
        </div>

        <div id="quiz-content" class="tab-content" style="display:none;">
            <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Upload a File to Generate a Quiz</h3>
            <form action="/upload-quiz" method="post" enctype="multipart/form-data" class="mb-8 space-y-4">
                <input type="file" name="file" accept=".pdf,.docx" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-[#eaf8f4] file:text-[#2DC6A1]
                    hover:file:bg-[#d8f0e9]">
                <button type="submit" class="bg-[#2DC6A1] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#24a284] btn-primary">Upload and Generate Quiz</button>
            </form>
        </div>

        <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Your Study Sets</h3>
        {% if study_sets %}
            <ul class="space-y-3">
                {% for study_set in study_sets %}
                    <li class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center card-hover-effect">
                        <button onclick="getStudySetContent('{{ study_set.id }}')" class="text-[#2DC6A1] hover:underline text-lg font-medium">{{ study_set.document_name }}</button>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-500 text-sm">Uploaded: {{ study_set.upload_timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                            <form action="/delete-study-set/{{ study_set.id }}" method="post" onsubmit="return confirm('Are you sure you want to delete this study set?');">
                                <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm font-semibold">Delete</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600">No study sets saved yet.</p>
        {% endif %}

        <div id="study-set-content-display" class="mt-8"></div>
    </div>
</div>

<style>
    .tab-btn {
        padding: 1rem 1.5rem;
        cursor: pointer;
        border: none;
        background-color: transparent;
        font-size: 1rem;
        font-weight: 600;
        color: #6C7486;
        transition: all 0.3s ease;
    }
    .active-tab {
        color: #2DC6A1;
        border-bottom: 2px solid #2DC6A1;
    }
</style>

<script>
    let activeTab = 'summary';

    function showTab(tabName) {
        // Hide all tab content
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.style.display = 'none';
        });

        // Deactivate all tab buttons
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
            button.classList.remove('active-tab');
        });

        // Show the selected tab content
        document.getElementById(tabName + '-content').style.display = 'block';

        // Activate the selected tab button
        document.getElementById(tabName + '-btn').classList.add('active-tab');

        activeTab = tabName;
        document.getElementById('study-set-content-display').innerHTML = ''; // Clear content when switching tabs
    }

    async function getStudySetContent(studySetId) {
        const display = document.getElementById('study-set-content-display');
        display.innerHTML = '<p>Loading...</p>';

        try {
            const response = await fetch(`/get-study-set-content/${studySetId}/${activeTab}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            let contentHtml = '';
            if (activeTab === 'summary') {
                const converter = new showdown.Converter();
                contentHtml = converter.makeHtml(data.content);
            } else if (activeTab === 'flashcards') {
                data.content.forEach(card => {
                    contentHtml += `
                        <div class="flashcard card-hover-effect" onclick="this.classList.toggle('flipped')">
                            <div class="flashcard-inner">
                                <div class="flashcard-front bg-[#EDF5FD]">
                                    <p class="text-[#0E0E12] font-medium"><strong>Q:</strong> ${card.question}</p>
                                </div>
                                <div class="flashcard-back bg-[#d8f0e9]">
                                    <p class="text-[#0E0E12]"><strong>A:</strong> ${card.answer}</p>
                                </div>
                            </div>
                        </div>`;
                });
                contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">${contentHtml}</div>`;
            } else if (activeTab === 'quiz') {
                let questionsHtml = '';
                data.content.forEach((item, index) => {
                    let optionsHtml = '';
                    item.options.forEach(option => {
                        optionsHtml += `<label class="block"><input type="radio" name="question-${index}" value="${option}" class="mr-2">${option}</label>`;
                    });
                    questionsHtml += `
                        <div class="mb-4">
                            <p class="font-semibold">${index + 1}. ${item.question}</p>
                            <div class="pl-4">${optionsHtml}</div>
                            <p class="text-sm text-gray-500 mt-1" style="display:none;">Correct Answer: ${item.correct_answer}</p>
                        </div>`;
                });
                contentHtml = `<form id="quiz-form">${questionsHtml}<button type="submit" class="bg-[#2DC6A1] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#24a284] btn-primary mt-4">Submit Quiz</button></form><div id="quiz-results" class="mt-4"></div>`;
            }
            display.innerHTML = contentHtml;

            if (activeTab === 'quiz') {
                const quizForm = document.getElementById('quiz-form');
                quizForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    let score = 0;
                    const totalQuestions = data.content.length;
                    data.content.forEach((item, index) => {
                        const selectedOption = quizForm.querySelector(\`input[name="question-\${index}"]:checked\`);
                        const correctAnswer = item.correct_answer;
                        const questionResult = quizForm.querySelectorAll('.text-sm')[index];
                        questionResult.style.display = 'block';
                        if (selectedOption && selectedOption.value === correctAnswer) {
                            score++;
                            selectedOption.parentElement.style.color = 'green';
                        } else if(selectedOption) {
                            selectedOption.parentElement.style.color = 'red';
                        }
                    });
                    const resultsDiv = document.getElementById('quiz-results');
                    resultsDiv.innerHTML = \`<p class="font-bold text-xl">You scored \${score} out of \${totalQuestions}</p>\`;
                });
            }

        } catch (error) {
            display.innerHTML = '<p class="text-red-500">Error loading content.</p>';
            console.error('There was a problem with the fetch operation:', error);
        }
    }
</script>

{% endblock %}