
{% extends 'base.html' %}

{% block title %}Dashboard - StudyBuddy AI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white p-8 rounded-2xl shadow-md">
        <h2 class="text-3xl font-bold text-[#0E0E12] mb-6">Welcome to your Dashboard, {{ user.email }}!</h2>

        {% if message %}
            <p class="text-[#2DC6A1] mb-4">{{ message }}</p>
        {% endif %}
        {% if error %}
            <p class="text-[#FF6F61] mb-4">{{ error }}</p>
        {% endif %}

        <div class="mb-8">
            <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Upload a File to Generate Study Materials</h3>
            <form action="/upload-document" method="post" enctype="multipart/form-data" class="mb-8 space-y-4">
                <input type="file" name="file" accept=".pdf,.docx" required class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-[#eaf8f4] file:text-[#2DC6A1]
                    hover:file:bg-[#d8f0e9]">
                <button type="submit" class="bg-[#2DC6A1] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#24a284] btn-primary">Upload and Generate All Study Materials</button>
            </form>
        </div>

        <h3 class="text-2xl font-semibold text-[#2DC6A1] mb-4">Your Study Sets</h3>
        {% if study_sets %}
            <ul class="space-y-3">
                {% for study_set in study_sets %}
                    <li class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center card-hover-effect">
                        <button onclick="getStudySetContent('{{ study_set.id }}')" class="text-[#2DC6A1] hover:underline text-lg font-medium">{{ study_set.document_name }}</button>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-500 text-sm">Uploaded: {{ study_set.upload_timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                            <form action="/delete-study-set/{{ study_set.id }}" method="post" onsubmit="return confirm('Are you sure you want to delete this study set?');">
                                <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm font-semibold">Delete</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600">No study sets saved yet.</p>
        {% endif %}

        <div id="study-set-content-display" class="mt-8"></div>
    </div>
</div>

<style>
    /* Removed tab-btn and active-tab styles as they are no longer needed for upload forms */
</style>

<script>
    // activeTab will now default to 'summary' or the first type we want to display.
    // The showTab function is no longer needed for upload forms, but still relevant for displaying content.
    let activeTab = 'summary'; // Default to summary for displaying existing study sets.

    // I will adjust the showTab function here slightly to reflect that it's only for content display now
    // and that the tab buttons are part of study_session.html
    // For dashboard, when clicking on a study set, it should default to displaying summary or a default.

    async function getStudySetContent(studySetId) {
        const display = document.getElementById('study-set-content-display');
        display.innerHTML = '<p>Loading...</p>';

        try {
            // When clicking a study set from dashboard, default to summary content type
            const response = await fetch(`/get-study-set-content/${studySetId}/summary`); // Always fetch summary first
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            let contentHtml = '';
            const converter = new showdown.Converter(); // Assuming showdown.js is included somewhere else or will be.
            contentHtml = converter.makeHtml(data.content);
            
            // Redirect to study_session page with the ID and potentially default content type
            window.location.href = `/study-sets/${studySetId}?default_tab=summary`;

        } catch (error) {
            display.innerHTML = '<p class="text-red-500">Error loading content.</p>';
            console.error('There was a problem with the fetch operation:', error);
        }
    }
</script>

{% endblock %}